# Упражнение 3: Создание Dockerfile для Python-скрипта "Hello, World!"

![Иллюстрация: Мария Фоканова](/images/podman_upr3.png)
*Иллюстрация: Мария Фоканова*

Dockerfile – это сценарий сборки образа. В сценарии описываются шаги того, как из базового образа получить новый образ с выбранным приложением. Базовый образ обычно содержит ОС и среду (например, Python). Инструкции Dockerfile выполняются по порядку, формируя слои образа.

Минимальный Dockerfile для Python-приложения может включать инструкции:
```
FROM – указывает базовый образ (например, Python 3).
COPY или ADD – копирует файлы приложения в образ.
RUN – выполняет команды в процессе сборки (например, установку зависимостей).
CMD или ENTRYPOINT – определяет команду, которая запустится при старте контейнера из образа.
```

Мы создадим образ, который при запуске будет выполнять простой скрипт "Hello, World!". В результате получим собственный код в образе для контейнера.

---

## Подготовка проекта

Создадим новый пустой каталог для проекта, например ~/alt-podman-python-hello. Перейдем в него и создадим файл hello.py со следующим содержимым:
```bash
print("Hello, World!")
```
Это простейший Python-скрипт, печатающий приветствие.

## Минимальный Dockerfile

В том же каталоге создадим файл Dockerfile (без расширения). Заглавный регистр в названии файла имеет значение. Заполним этот файл.

```bash
# Используем базовый образ с Python 3 на ветке sisyphus (слой с интерпретатором Python).
FROM registry.altlinux.org/alt/python:sisyphus

# Устанавливаем рабочий каталог в контейнере
WORKDIR /app

# Копируем наш скрипт в образ
COPY hello.py /app/

# Определяем команду по умолчанию: запуск Python-скрипта
CMD [/"python3/", /"hello.py/"]
```

Разберём содержимое:

- ```FROM``` указывает базовый образ – здесь взят облегченый ```Python 3.12.8```. Он содержит сам Python, поэтому нам не нужно устанавливать интерпретатор вручную.
- ```WORKDIR``` создаёт (если нет) и устанавливает рабочий каталог ```/app```. Дальнейшие команды ```COPY```, ```CMD``` интерпретируются относительно этого каталога.
- ```COPY``` копирует файл ```hello.py``` внутрь образа, в каталог ```/app```.
- ```CMD``` задаёт команду, которая выполнится при запуске контейнера из этого образа. Здесь мы запускаем Python с нашим скриптом.

## Сборка образа

Убедимся, что в каталоге находятся Dockerfile и hello.py. Выполним команду сборки:

```bash
podman build -t hello-python .
```

- Ключ ```-t hello-python``` задаёт имя (тег) для нового образа
- Точка``` .``` указывает путь к Dockerfile (текущий каталог). 

Podman последовательно выполнит шаги: возьмёт образ ```python:latest```, скопирует файл, задаст команду. По окончании мы должны увидеть сообщение о успешной сборке и строку с ```Successfully tagged hello-python:latest``` (или подобную).

Список локальных образов можно проверить командой ```podman images```. Видим новый образ ```hello-python:latest``` в списке.

## Запуск контейнера из созданного образа

Теперь протестируем наш образ:
```podman run --rm hello-python```

Флаг ```--rm``` можно использовать для удаления контейнера после завершения. Контейнер запустится и должен мгновенно завершиться, выведя в консоль ```Hello, World!```. Так как мы указали CMD, нам не нужно вручную писать команду запуска — она взята из образа.

## Отладка, если что-то пошло не так

Если контейнер не запускается, проверим: правильно ли назван файл (```Dockerfile```, а не dockerfile.txt, например), верно ли написаны инструкции. Можно просмотреть логи сборки (```podman build``` выводит пошагово действия) или запустить контейнер в интерактиве: ```podman run -it --entrypoint bash hello-python``` – это даст оболочку внутри контейнера, где можно убедиться, что файл ```hello.py``` на месте и Python запускается.

## Задание для самостоятельной работы

1. Модифицируем созданный образ или создадим новый для практики:

Изменим скрипт ```hello.py```, чтобы он, кроме ```"Hello, World!"```, выводил, например, текущее время или имя пользователя. Для получения текущего времени можно использовать модуль datetime.

Файл ```hello-date.py```
```bash
from datetime import datetime

# Вывод сообщения
print("Привет, мир!")

# Вывод текущей даты и времени
now = datetime.now()
print("Текущая дата и время:", now.strftime("%Y-%m-%d %H:%M:%S"))
```

Построим новый образ (например, с тегом ```hello-python:v2```) и запустим его, убедившись, что он выводит обновленное сообщение.

2. Попробуем использовать в Dockerfile другой базовый образ. Например, заменим ```registry.altlinux.org/alt/python:sisyphus``` на ```registry.altlinux.org/alt/alt:p10``` (минимальный образ ALT Linux) и добавим команду установки Python:

```
FROM registry.altlinux.org/alt/alt:p10
RUN apt-get update && apt-get install -y python3
```

Остальные шаги аналогичны копированию скрипта и запуску. Соберем образ и проверим работоспособность. Обратим внимание на разницу объема в образах podman images, поскольку мы ставим Python поверх базовой системы ALT.

## Ожидаемый итог:
- мы создали свой первый Dockerfile и на его основе – образ контейнера с Python-скриптом;
- запустили контейнер hello-python и получили вывод ```“Hello, World!”``` из изолированного окружения;
- cамостоятельный образ с модифицированным скриптом успешно выводит дополнительную информацию;
- эксперимент с альтернативным базовым образом ALT Linux также должен пройти успешно: контейнер на ```ALT:p10``` выводит то же сообщение